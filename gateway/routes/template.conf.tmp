# -----------------------------------------------------------
# ğŸ§­ NGINX ì„¤ì •: template ì„œë¹„ìŠ¤ ìš”ì²­ ì²˜ë¦¬
# -----------------------------------------------------------
# ì´ ì„¤ì •ì€ Gatewayì—ì„œ /template ê²½ë¡œë¡œ ë“¤ì–´ì˜¨ ìš”ì²­ì„
# ë‚´ë¶€ template-serviceë¡œ í”„ë¡ì‹œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.
#
# êµ¬ì¡°ì  ëª©ì :
# - /template/static/ ê²½ë¡œ: ì •ì  íŒŒì¼ ì§ì ‘ ì„œë¹™ (nginx alias)
# - /template/ ì´í•˜ ë‚˜ë¨¸ì§€ ê²½ë¡œ: ë‚´ë¶€ ì„œë¹„ìŠ¤ë¡œ í”„ë¡ì‹œ
#
# ì„œëª… ê¸°ë°˜ ì¸ì¦(Signature Authentication)ì€ Lua ë¯¸ë“¤ì›¨ì–´ë¡œ ìˆ˜í–‰ë˜ë©°,
# ì•„ë˜ set ì§€ì‹œì–´ë¥¼ í†µí•´ ê²½ë¡œë³„ ì¸ì¦ ì ìš© ì—¬ë¶€ë¥¼ ì œì–´í•©ë‹ˆë‹¤.
# -----------------------------------------------------------

# âœ… /template/static/ ìš”ì²­ì€ ì •ì  ë¦¬ì†ŒìŠ¤ë¡œ ì²˜ë¦¬
location /template/static/ {
    alias /usr/share/nginx/static/template/;
}

# âœ… /template ê²½ë¡œ ì „ì²´ í”„ë¡ì‹œ + Signature ë¯¸ë“¤ì›¨ì–´ ì ìš©
location /template/ {

    # -------------------------------------------------------
    # ğŸ“Œ Signature ê²€ì¦ ëŒ€ìƒ ê²½ë¡œ ì •ì˜ (ì •ê·œì‹)
    # -------------------------------------------------------
    # ì´ ì •ê·œì‹ì— ë§¤ì¹­ë˜ëŠ” ìš”ì²­ë§Œ Signature ì¸ì¦ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    # ì˜ˆ: /template/api/**, /template/secure/**, /template/auth/**
    #
    # ê¸°ë³¸ê°’ì€ "/api/"ë§Œ í¬í•¨ë˜ë‚˜, í•„ìš”ì— ë”°ë¼ í™•ì¥ ê°€ëŠ¥
    #
    # âš ï¸ ì£¼ì˜: '$' ê°™ì€ íŠ¹ìˆ˜ë¬¸ìëŠ” ì´ ì„¤ì •ì— í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    #         Lua ì½”ë“œì—ì„œ ì •ê·œì‹ ëì— '$'ë¥¼ ìë™ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
    #
    set $signature_match_regex "/template/(api|secure|auth)/";

    # -------------------------------------------------------
    # ğŸ“Œ Signature ê²€ì¦ ì˜ˆì™¸ ê²½ë¡œ ì •ì˜ (ì •ê·œì‹)
    # -------------------------------------------------------
    # match_regexì— ê±¸ë¦¬ë”ë¼ë„, ì•„ë˜ ì •ê·œì‹ì— í¬í•¨ë˜ëŠ” ê²½ìš°ëŠ”
    # Signature ê²€ì¦ì„ ìƒëµí•˜ê³  í†µê³¼ì‹œí‚µë‹ˆë‹¤.
    #
    # ì˜ˆ: /template/api/ping, /template/api/ping/aaa ë“±
    #
    # ----------------- ì˜ˆì‹œ ì •ê·œì‹ ë¬¸ë²• ---------------------
    # - "/template/api/ping"                         â†’ ping ë‹¨ë…
    # - "/template/api/(ping|sync|healthz)"          â†’ ì—¬ëŸ¬ ì—”ë“œí¬ì¸íŠ¸ í—ˆìš©
    # - "^/template/api/public/.*"                   â†’ public í•˜ìœ„ ì „ì²´ í—ˆìš©
    # - "^/template/api/.*/metrics"                  â†’ metricsë¡œ ëë‚˜ëŠ” URI í—ˆìš©
    # - "^/template/api/ping(/.*)?"                  â†’ ping ë˜ëŠ” ping í•˜ìœ„ ì „ì²´ í—ˆìš©
    #
    # âš ï¸ ì£¼ì˜:
    # - ìœ„ ì˜ˆì‹œì—ëŠ” ëª¨ë‘ '$'ë¥¼ í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    # - ì‹¤ì œ ì¸ì¦ ë¡œì§ì—ì„œ Luaê°€ ìë™ìœ¼ë¡œ ë¬¸ìì—´ ëì— '$'ë¥¼ ì¶”ê°€í•´
    #   **"í•´ë‹¹ ê²½ë¡œë¡œ ì •í™•íˆ ëë‚˜ëŠ”ì§€"** ë˜ëŠ” **"ì§€ì •ëœ íŒ¨í„´ì´ ë§ˆì§€ë§‰ì¸ì§€"**ë¥¼ ê²€ì‚¬í•©ë‹ˆë‹¤.
    # - OpenResty í™˜ê²½ì—ì„œ '$'ë¥¼ ì§ì ‘ ë„£ìœ¼ë©´ ì„¤ì • íŒŒì‹± ì‹œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë¯€ë¡œ ì£¼ì˜í•˜ì‹­ì‹œì˜¤.
    # -------------------------------------------------------

    set $signature_whitelist_regex "^/template/api/ping(/.*)?";

    # ğŸ“¦ Signature ë¯¸ë“¤ì›¨ì–´ Lua íŒŒì¼ ì ìš©
    access_by_lua_file /etc/nginx/lua/signature_verify.lua;

    # ğŸ” ë‚´ë¶€ template-service ë¡œ ìš”ì²­ í”„ë¡ì‹œ
    proxy_pass http://template-service:80/template/;

    # ğŸ”§ ê³µí†µ í—¤ë” ì„¤ì • (ì‚¬ìš©ì ì •ë³´ ë“±)
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-User-ID $http_x_user_id;
    proxy_set_header Origin $http_origin;
}
